#!/bin/sh

DATABASE_DIR=/var/lib/hoogle/databases
HOOGLE=/usr/bin/hoogle
URLPREFIX=http://localhost/cgi-bin/dwww

# cleanup
rm -rf $DATABASE_DIR/*

# copy (fake) files
mkdir -p $DATABASE_DIR/download/hackage-cabal
cd $DATABASE_DIR/download && touch hackage-cabal.txt hackage-hoogle.txt haskell-platform.cabal base.txt ghc.txt
cp /usr/share/hoogle/predownload/keyword.txt $DATABASE_DIR/download/

# new database
$HOOGLE data keyword

echo "Collect txt files on ghc-doc"
find /usr/share/doc/ghc-doc/html/libraries/*/ -name "*.txt*" 2>/dev/null | \
  haddock_collect $URLPREFIX $DATABASE_DIR/

echo "Collect txt files on libghc-*-doc"
find /usr/share/doc/libghc-*-doc/html/ -name "*.txt*" 2>/dev/null | \
  haddock_collect $URLPREFIX $DATABASE_DIR/

# convert
for i in $DATABASE_DIR/*.txt; do
    echo "Convert $i"
    $HOOGLE convert $i >/dev/null 2>&1
done

# combine
cd $DATABASE_DIR/ && $HOOGLE combine *.hoo
