#!/bin/sh

readlinks() {
  for i in $*; do
    readlink -f $i
  done
}

SHIPPED_DIR=/usr/share/hoogle/predownload
DATABASE_DIR=/var/lib/hoogle/databases
HOOGLE=/usr/bin/hoogle

# cleanup
rm -rf $DATABASE_DIR/*

# convert
echo -n "Converting databases."
TXTFILES_SYM=`find /usr/lib/ghc-doc/hoogle/ -name "*.txt"`
TXTFILES=`readlinks $TXTFILES_SYM`
for i in $TXTFILES; do
  if [ -r "$i" ]; then
    echo -n "."
    $HOOGLE convert $i $DATABASE_DIR/`basename $i`.hoo --addlocation >/dev/null 2>&1
  fi
done
# convert the pre-shipped keyword file (no addlocation here!)
$HOOGLE convert $SHIPPED_DIR/keyword.txt $DATABASE_DIR/keyword.txt.hoo >/dev/null 2>&1
echo " done"

# combine, removing first default.hoo (if by any chance the above
# commands generated one)
rm -f $DATABASE_DIR/default.hoo
find $DATABASE_DIR -name \*.hoo -print0 | \
  xargs -0 -- hoogle combine -o $DATABASE_DIR/default.hoo
