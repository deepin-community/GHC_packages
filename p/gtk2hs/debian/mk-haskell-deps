#!/bin/sh

# Copyright (C) 2004, Martin Sj√∂gren <sjogren@debian.org>

# This script creates a dummy haskell program, and compiles it with
# a list of ghc packages, and then runs dpkg-shlibdeps on it to figure out
# what dependencies a libghc6-*-dev package needs to have.

# Idea: mangle library_dirs and compile with a dummy package.conf
#   will sed magick be enough or should the .conf files be properly parsed?
# How do we figure out all the .conf files and packages? Heckuva long command
# line if we can't do it automatically...

if [ $# -lt 2 ]; then
    echo "Usage: $0 debname pkg:pkgconf [pkg:pkgconf ...]"
    exit 1
fi

deb=$1
shift

T_DIR=debian/tmp/mk-deps
mkdir -p $T_DIR

cp `ghc --print-libdir`/package.conf $T_DIR/package.conf
packages=
for pkgpair in $@; do
    pkg=`echo $pkgpair | cut -d: -f1`
    pkgconf=`echo $pkgpair | cut -d: -f2`
    pkgconflocal=$T_DIR/$pkg.package.conf
    pkgdir=`echo $pkgconf | sed -ne "s#^.*debian/libghc6-$pkg-dev\(/.*\)/\([^/]\+\)#\1#p"`
    packages="$packages -package $pkg"
    cat $pkgconf \
      | sed -e \
        "/^\(import\|library\|include\)-dirs: / { \
          s#\"$pkgdir#\"$PWD/debian/libghc6-$pkg-dev$pkgdir#g }" \
      > $pkgconflocal
    ghc-pkg -f $T_DIR/package.conf register $pkgconflocal --force 2>&1 > /dev/null || true
done
echo "module Main where main = return ()" > $T_DIR/a.hs
ghc --make $T_DIR/a.hs -o $T_DIR/a.out -package-conf $T_DIR/package.conf $packages
for pkgpair in $@; do
    pkg=`echo $pkgpair | cut -d: -f1`
    ghc-pkg -f $T_DIR/package.conf unregister $pkg --force
done;
dpkg-shlibdeps -Tdebian/$deb.substvars $T_DIR/a.out
rm -rf $T_DIR
