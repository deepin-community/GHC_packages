Index: haskell-haddock-2.9.2/src/Haddock/Interface/AttachInstances.hs
===================================================================
--- haskell-haddock-2.9.2.orig/src/Haddock/Interface/AttachInstances.hs	2011-05-27 17:17:47.022293394 +0100
+++ haskell-haddock-2.9.2/src/Haddock/Interface/AttachInstances.hs	2011-05-27 17:38:35.193733579 +0100
@@ -31,7 +31,9 @@
 import HscTypes (withSession)
 #endif
 import MonadUtils (liftIO)
+#ifdef GHCI
 import TcRnDriver (tcRnGetInfo)
+#endif
 import TypeRep hiding (funTyConName)
 import Var hiding (varName)
 import TyCon
@@ -56,7 +58,11 @@
 attachToExportItem iface ifaceMap instIfaceMap export =
   case export of
     ExportDecl { expItemDecl = L _ (TyClD d) } -> do
+#ifdef GHCI
       mb_info <- getAllInfo (unLoc (tcdLName d))
+#else
+      let mb_info = Nothing
+#endif
       let export' =
             export {
               expItemInstances =
@@ -97,10 +103,12 @@

 -- | Like GHC's getInfo but doesn't cut things out depending on the
 -- interative context, which we don't set sufficiently anyway.
+#ifdef GHCI
 getAllInfo :: GhcMonad m => Name -> m (Maybe (TyThing,Fixity,[Instance]))
 getAllInfo name = withSession $ \hsc_env -> do
    (_msgs, r) <- liftIO $ tcRnGetInfo hsc_env name
    return r
+#endif


 --------------------------------------------------------------------------------
Index: haskell-haddock-2.9.2/haddock.cabal
===================================================================
--- haskell-haddock-2.9.2.orig/haddock.cabal	2011-05-27 17:17:47.052292123 +0100
+++ haskell-haddock-2.9.2/haddock.cabal	2011-05-27 17:24:23.000000000 +0100
@@ -72,6 +72,10 @@
   default: False
   manual: True

+flag ghci
+  default: True
+  manual: True
+
 executable haddock
   default-language:     Haskell2010
   build-depends:
@@ -154,6 +158,9 @@
     cpp-options: -DTEST
     build-depends: QuickCheck >= 2.1 && < 3

+  if flag(ghci)
+    cpp-options: -DGHCI
+
   hs-source-dirs:       src
   default-extensions:   CPP, DeriveDataTypeable,
                         ScopedTypeVariables, MagicHash
Index: haskell-haddock-2.9.2/src/Haddock/Interface/Create.hs
===================================================================
--- haskell-haddock-2.9.2.orig/src/Haddock/Interface/Create.hs	2011-05-27 17:17:47.012293842 +0100
+++ haskell-haddock-2.9.2/src/Haddock/Interface/Create.hs	2011-05-27 17:24:23.000000000 +0100
@@ -518,7 +518,11 @@
         Nothing -> do
           -- If we can't find the declaration, it must belong to
           -- another package
+#ifdef GHCI
           mbTyThing <- liftGhcToErrMsgGhc $ lookupName t
+#else
+          mbTyThing <- liftGhcToErrMsgGhc $ lookupGlobalName t
+#endif
           -- show the name as exported as well as the name's
           -- defining module (because the latter is where we
           -- looked for the .hi/.haddock).  It's to help people
