From 46a4e24d6b03ed88915541a57650f78ec06f6250 Mon Sep 17 00:00:00 2001
From: John MacFarlane <jgm@berkeley.edu>
Date: Tue, 30 May 2023 10:28:19 -0700
Subject: [PATCH] Add typst reader.

New module Text.Pandoc.Readers.Typst [API change].
---
 MANUAL.txt                               |   1 +
 cabal.project                            |   4 +-
 pandoc.cabal                             |   9 +-
 shell.nix                                |   1 -
 src/Text/Pandoc/Format.hs                |   1 +
 src/Text/Pandoc/Readers.hs               |   3 +
 src/Text/Pandoc/Readers/Typst.hs         | 520 +++++++++++++++++++++++
 src/Text/Pandoc/Readers/Typst/Math.hs    | 376 ++++++++++++++++
 src/Text/Pandoc/Readers/Typst/Parsing.hs |  61 +++
 src/Text/Pandoc/Writers/Typst.hs         |   5 -
 stack.yaml                               |   6 +-
 test/command/6288.md                     |   4 +-
 test/epub/features.native                |   4 +-
 13 files changed, 978 insertions(+), 17 deletions(-)
 create mode 100644 src/Text/Pandoc/Readers/Typst.hs
 create mode 100644 src/Text/Pandoc/Readers/Typst/Math.hs
 create mode 100644 src/Text/Pandoc/Readers/Typst/Parsing.hs

diff --git a/test/epub/features.native b/test/epub/features.native
index ef5f0d032c1e..2a458009251c 100644
--- a/test/epub/features.native
+++ b/test/epub/features.native
@@ -1281,7 +1281,7 @@
         , Plain
             [ Math
                 DisplayMath
-                "\\begin{matrix}\n & {\\operatorname{cov}(\\mathcal{L})} & \\longrightarrow & {\\operatorname{non}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cof}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cof}(\\mathcal{L})} & \\longrightarrow & 2^{\\aleph_{0}} \\\\\n & \\uparrow & & \\uparrow & & \\uparrow & & \\uparrow & & \\\\\n & {\\mathfrak{b}} & \\longrightarrow & {\\mathfrak{d}} & & & & & & \\\\\n & \\uparrow & & \\uparrow & & & & & & \\\\\n\\aleph_{1} & \\longrightarrow & {\\operatorname{add}(\\mathcal{L})} & \\longrightarrow & {\\operatorname{add}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cov}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{non}(\\mathcal{L})} & \\\\\n\\end{matrix}"
+                "\\begin{matrix}\n & {\\operatorname{cov}(\\mathcal{L})} & \\longrightarrow & {\\operatorname{non}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cof}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cof}(\\mathcal{L})} & \\longrightarrow & 2^{\\aleph_{0}} \\\\\n & \\uparrow & & \\uparrow & & \\uparrow & & \\uparrow & & \\\\\n & {\\mathfrak{b}} & \\longrightarrow & {\\mathfrak{d}} & & & & & & \\\\\n & \\uparrow & & \\uparrow & & & & & & \\\\\n\\aleph_{1} & \\longrightarrow & {\\operatorname{add}(\\mathcal{L})} & \\longrightarrow & {\\operatorname{add}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{cov}(\\mathcal{K})} & \\longrightarrow & {\\operatorname{non}(\\mathcal{L})} & \n\\end{matrix}"
             ]
         , Para
             [ Str "The"
@@ -1352,7 +1352,7 @@
         , Plain
             [ Math
                 DisplayMath
-                "{\1583(\1587)} = \\left\\{ \\begin{matrix}\n{\\sum\\limits_{\1646 = 1}^{\1589}\1587^{\1646}} & {\\text{\1573\1584\1575\1603\1575\1606}\1587 > 0} \\\\\n{\\int_{1}^{\1589}{\1587^{\1646}\1569\1587}} & {\\text{\1573\1584\1575\1603\1575\1606}\1587 \\in \1605} \\\\\n{{\1591\1575}\\pi} & {\\text{\1594\1610\1585\1584\1604\1603}\\left( \\text{\1605\1593}\\pi \\simeq 3,141 \\right)} \\\\\n\\end{matrix} \\right."
+                "{\1583(\1587)} = \\left\\{ \\begin{matrix}\n{\\sum\\limits_{\1646 = 1}^{\1589}\1587^{\1646}} & {\\text{\1573\1584\1575\1603\1575\1606}\1587 > 0} \\\\\n{\\int_{1}^{\1589}{\1587^{\1646}\1569\1587}} & {\\text{\1573\1584\1575\1603\1575\1606}\1587 \\in \1605} \\\\\n{{\1591\1575}\\pi} & {\\text{\1594\1610\1585\1584\1604\1603}\\left( \\text{\1605\1593}\\pi \\simeq 3,141 \\right)}\n\\end{matrix} \\right."
             ]
         , Para
             [ Str "The"
